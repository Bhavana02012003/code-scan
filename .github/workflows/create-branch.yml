name: Create Temporary Branch

on:
  repository_dispatch:
    types: [create-branch]

permissions:
  contents: write

jobs:
  create-branch:
    runs-on: ubuntu-latest

    steps:
    # ----------------------------------------------------
    # 1. Checkout orchestrator repo (your current repo)
    # ----------------------------------------------------
    - name: Checkout orchestrator repo
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2. Generate GitHub App Token (repo-scoped)
    # ----------------------------------------------------
    - name: Generate GitHub App Token
      id: token
      uses: tibdex/github-app-token@v2
      with:
        app_id: ${{ secrets.GH_APP_ID }}
        private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        installation_retrieval_mode: repository
        installation_retrieval_payload: ${{ github.event.client_payload.owner }}/${{ github.event.client_payload.repo }}

    # ----------------------------------------------------
    # 3. Clone the actual target repo using app token
    # ----------------------------------------------------
    - name: Clone target repo
      run: |
        echo "Cloning target repo..."
        git clone https://x-access-token:${{ steps.token.outputs.token }}@github.com/${{ github.event.client_payload.owner }}/${{ github.event.client_payload.repo }}.git target

    # ----------------------------------------------------
    # 4. Create new branch, add a file, commit, push
    # ----------------------------------------------------
    - name: Create & Push Feature Branch
      working-directory: target
      run: |
        echo "Switching to base branch: ${{ github.event.client_payload.target_branch }}"
        git checkout ${{ github.event.client_payload.target_branch }}

        echo "Creating new feature branch: ${{ github.event.client_payload.feature_branch }}"
        git checkout -b ${{ github.event.client_payload.feature_branch }}

        echo "Configuring git identity..."
        git config user.email "remote-code-scan-bot@github.com"
        git config user.name  "Remote Code Scan Bot"

        echo "Writing branch-info.txt file..."
        echo "Temporary branch created at $(date)" > branch-info.txt
        git add branch-info.txt
        git commit -m "Create temporary branch via GitHub App"

        echo "Pushing branch to origin..."
        git push https://x-access-token:${{ steps.token.outputs.token }}@github.com/${{ github.event.client_payload.owner }}/${{ github.event.client_payload.repo }}.git ${{ github.event.client_payload.feature_branch }}

        echo "Branch pushed successfully!"
