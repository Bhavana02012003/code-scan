name: Create Temporary Branch and Apply Fix

on:
  repository_dispatch:
    types: [create-branch]

permissions:
  contents: write

jobs:
  apply-fix:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate GitHub App Token
        id: token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          installation_retrieval_mode: repository
          installation_retrieval_payload: ${{ github.event.client_payload.owner }}/${{ github.event.client_payload.repo }}

      - name: Clone target repo
        run: |
          git clone https://x-access-token:${{ steps.token.outputs.token }}@github.com/${{ github.event.client_payload.owner }}/${{ github.event.client_payload.repo }}.git target

      - name: Decode code snippets
        run: |
          echo "${{ github.event.client_payload.original_code_b64 }}" | base64 --decode > original.txt
          echo "${{ github.event.client_payload.fixed_code_b64 }}"    | base64 --decode > fixed.txt

      # ===========================================================
      # CREATE method_replace.pl  (Correct name & path)
      # ===========================================================
      - name: Create method-level replace script
        run: |
          cat << 'EOF' > method_replace.pl
          use strict;
          use warnings;
          local $/;

          my $file = $ARGV[0];

          my $orig = do { local $/; open my $fh, "original.txt" or die $!; <$fh> };
          my $fix  = do { local $/; open my $fh, "fixed.txt"    or die $!; <$fh> };

          $orig =~ s/\r//g;
          $fix  =~ s/\r//g;

          open my $fh_in, "<", $file or die $!;
          my $content = do { local $/; <$fh_in> };
          close $fh_in;

          my ($methodSignature) = ($orig =~ /(public|private|protected)\s+[\w<>\[\]]+\s+\w+\s*\([^)]*\)/);

          if (!$methodSignature) {
              print "‚ùå No method signature found.\n";
              exit 1;
          }

          my $safe = quotemeta($methodSignature);

          if ($content =~ /($safe\s*\{)/s) {
              my $start = $-[0];
              my $brace = 0;
              my $i = $start;

              for (; $i < length($content); $i++) {
                  my $ch = substr($content, $i, 1);
                  $brace++ if $ch eq '{';
                  $brace-- if $ch eq '}';
                  last if $brace == 0;
              }

              my $end = $i + 1;
              my $oldBlock = substr($content, $start, $end - $start);

              my $newContent = $content;
              $newContent =~ s/\Q$oldBlock\E/$fix/s;

              open my $fh_out, ">", $file or die $!;
              print $fh_out $newContent;
              close $fh_out;

              print "‚úÖ Method replaced successfully.\n";
          } else {
              print "‚ùå Method signature not found in file.\n";
              exit 1;
          }
          EOF

      # ===========================================================
      # EXECUTE THE FIX
      # ===========================================================
      - name: Create branch & apply fix
        working-directory: target
        run: |
          set -e
          git checkout "${{ github.event.client_payload.target_branch }}"
          git checkout -b "${{ github.event.client_payload.feature_branch }}"

          FILE="${{ github.event.client_payload.file_path }}"

          sed -i 's/\r$//' ../original.txt
          sed -i 's/\r$//' ../fixed.txt
          sed -i 's/\r$//' "$FILE"

          echo "üß† Running method_replace.pl..."
          perl ../method_replace.pl "$FILE"

          echo "// AUTO-FIX APPLIED" >> "$FILE"

          git config user.email "branch-bot@example.com"
          git config user.name "Branch Bot"
          git add "$FILE"
          git commit -m "Apply AI Auto Fix"
          git push --set-upstream origin "${{ github.event.client_payload.feature_branch }}"
