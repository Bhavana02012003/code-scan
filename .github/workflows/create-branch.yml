name: Create Temporary Branch and Apply Fix

on:
  repository_dispatch:
    types: [create-branch]

permissions:
  contents: write

jobs:
  apply-fix:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate GitHub App Token
        id: token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          installation_retrieval_mode: repository
          installation_retrieval_payload: ${{ github.event.client_payload.owner }}/${{ github.event.client_payload.repo }}

      - name: Clone target repo
        run: |
          git clone https://x-access-token:${{ steps.token.outputs.token }}@github.com/${{ github.event.client_payload.owner }}/${{ github.event.client_payload.repo }}.git target

      - name: Decode code snippets
        run: |
          echo "${{ github.event.client_payload.original_code_b64 }}" | base64 --decode > original.txt
          echo "${{ github.event.client_payload.fixed_code_b64 }}"    | base64 --decode > fixed.txt

      - name: Create branch & apply fix
        working-directory: target
        run: |
          echo "ğŸ‘‰ Checking out target branch..."
          git checkout "${{ github.event.client_payload.target_branch }}"

          echo "ğŸ‘‰ Creating feature branch..."
          git checkout -b "${{ github.event.client_payload.feature_branch }}"

          FILE="${{ github.event.client_payload.file_path }}"
          echo "ğŸ“„ Target file: $FILE"

          echo "ğŸ”§ Normalizing CRLF/LF"
          sed -i 's/\r$//' ../original.txt
          sed -i 's/\r$//' ../fixed.txt
          sed -i 's/\r$//' "$FILE"

          echo "ğŸ” Checking for ORIGINAL block inside target file..."
          if grep -F "$(cat ../original.txt)" "$FILE"; then
            echo "âœ… ORIGINAL found â†’ Replacing block"
            perl -0777 -pi -e '
              use strict; use warnings;
              my $orig = do { local $/; open my $fh, "../original.txt"; <$fh> };
              my $fix  = do { local $/; open my $fh, "../fixed.txt"; <$fh> };

              $orig =~ s/\r//g;
              $fix  =~ s/\r//g;
              $_    =~ s/\r//g;

              s/\Q$orig\E/$fix/s;
            ' "$FILE"
          else
            echo "âŒ ORIGINAL block not found â€” overwriting file with FIXED code"
            cp ../fixed.txt "$FILE"
          fi

          echo "// AUTO-FIX APPLIED" >> "$FILE"

          echo "ğŸ¯ Committing & pushing changes"
          git config user.email "branch-bot@example.com"
          git config user.name  "Branch Bot"

          git add "$FILE"
          git commit -m "Apply AI Auto Fix"
          git push --set-upstream origin "${{ github.event.client_payload.feature_branch }}"
