name: Create Temporary Branch and Apply Fix

on:
  repository_dispatch:
    types: [create-branch]

permissions:
  contents: write

jobs:
  apply-fix:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate GitHub App Token
        id: token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          installation_retrieval_mode: repository
          installation_retrieval_payload: ${{ github.event.client_payload.owner }}/${{ github.event.client_payload.repo }}

      - name: Clone target repo
        run: |
          git clone https://x-access-token:${{ steps.token.outputs.token }}@github.com/${{ github.event.client_payload.owner }}/${{ github.event.client_payload.repo }}.git target

      - name: Create branch and apply fix
        working-directory: target
        run: |
          echo "ðŸ‘‰ Checking out main branch..."
          git checkout ${{ github.event.client_payload.target_branch }}

          echo "ðŸ‘‰ Creating feature branch..."
          git checkout -b ${{ github.event.client_payload.feature_branch }}

          FILE="${{ github.event.client_payload.file_path }}"
          echo "ðŸ“„ File to patch: $FILE"

          echo "ðŸ” Writing ORIGINAL code to tmp_original.txt"
          printf "%s" "${{ github.event.client_payload.original_code }}" > tmp_original.txt

          echo "ðŸ›  Writing FIXED code to tmp_fixed.txt"
          printf "%s" "${{ github.event.client_payload.fixed_code }}" > tmp_fixed.txt

          echo "ðŸ”„ Applying replacement..."
          ORIGINAL=$(sed -e 's/[\/&]/\\&/g' tmp_original.txt)
          FIXED=$(sed -e 's/[\/&]/\\&/g' tmp_fixed.txt)

          sed -i "s/$ORIGINAL/$FIXED/" "$FILE"

          echo "ðŸŽ¯ Git commit & push"
          git config user.email "branch-bot@example.com"
          git config user.name "Branch Bot"

          git add "$FILE"
          git commit -m "Apply AI Auto Fix"
          git push --set-upstream origin ${{ github.event.client_payload.feature_branch }}
